# Генератор Makefile

Этот сценарий генерирует `Makefile` для утилиты `make`. Теперь можно забыть про пакетные файлы и компиляцию из командной строки.

## Достоинства и недостатки

Не добавляет библиотеки в список. Библиотеки придётся добавлять руками.

### Что умеет

Без рантайма
Без си‐рантайма

### Недостатки

Не умеет строить зависимости от файла ресурсов.

### Почему утилита make

В простых проектах утилита `make` не даёт преимуществ по сравнению ручной компиляцией, но она проявит себя, когда программы станут более сложными. Когда исходный код вырастает до нескольких файлов, гораздо проще позволить утилите координировать сборку.

Предположим, наш проект состоит из сотни файлов. Когда мы изменяем одну строку кода в файле, то команда `fbc *.bas` перекомпилирует все файлы. Это занимает время, нагружает процессор и изнашивает диск. Утилита `make` пересобирает только изменившиеся файлы. Кроме того, мы не можем положить отладочную и окончательную версию по разным каталогам.

## Подготовления

### Утилита make

Необходимо где‐то достать утилиту `make`. Например, для Windows в одной из (сборок mingw от Brecht Sanders)[https://github.com/brechtsanders/winlibs_mingw/releases]. В этой сборке для операционной системы Windows утилита называется `mingw32-make`.

### Структура проекта

Генератор требует, чтобы проект был организован определённым образом:

```
MyProject
	bin\          — каталог для исполняемых файлов
		Debug\    — отладочная версия
			x64\  — для 64 бит
			x86\  — для 32 бит
		Release   — окончательная версия
			x64\
			x86\
	obj\          — каталог для объектных файлов
		Debug\
			x64\
			x86\
		Release
			x64\
			x86\
	src\          — каталог для файлов исходного кода
		main.bas  — все файлы исходного кода
		main.bi

	CreateMakefile.exe   — Генератор makefile

	Makefile             — сгенерированный файл

	setenv.cmd           — настройки переменных среды

	fix-emitted-code.vbs — сценарий для исправления промежуточного си‐кода (неообязательно)
```

К счастью, каталоги `bin` и `obj` вручную создавать не нужно, их можно создать командой `createdirs`.

### Компиляция генератора

Собрать генератор можно такой командой:

```
fbc64.exe -m CreateMakefile -x CreateMakefile.exe CreateMakefile.bas
```

## Параметры генератора Makefile

Параметры для утилиты указываются в виде пары: `-параметр значение`.

### makefile

Имя генерируемого файла для утилиты `make`.

По умолчанию равно `Makefile`.

### src

Каталог с исходными кодами.

По умолчанию равен `src`.

### fbc-path

Путь к файлу компилятора.

По умолчанию равно `C:\Program Files (x86)\FreeBASIC-1.10.1-winlibs-gcc-9.3.0`.

### fbc

Имя файла компилятора.

По умолчанию равно `fbc64.exe`.

### out

Имя исполняемого файла.

Имя файла указывается без расширения. Например, скомпилированная программа должна иметь имя `HelloWorld.exe`, указываем здесь `HelloWorld`.

По умолчанию равно `a`.

### module

Главный модуль программы.

По умолчанию равен названию программы (без расширения).

### exetype

Тип генерируемого исполняемого файла.

Может принимать следующий значения:

| Тип | Описание                          |
|-----|-----------------------------------|
| exe | Исполняемый файл |
| dll | Динамически загружаемая библиотека |
| lib | Статически загружаемая библиотека |
| wasm32 | WebAssembly |
| wasm64 | WebAssembly 64 бита |

По умолчанию равен `exe`.

Примечание: поддержка wasm64 в браузерах находится в экспериментальном режиме, и может не работать корректно.

### subsystem

Подсистема исполняемого файла. Применимо только к файлам типа `exe`.

| Подсистема | Описание                          |
|-----|-----------------------------------|
| console | Консольная программа для WinAPI |
| windows | Оконная программа для WinAPI |
| native | Программа для NT API |

По умолчанию равен `console`.

### emitter

Задаёт генератор промежуточного кода для цепочки инструментов.

| Генератор | Описание                          |
|-----|-----------------------------------|
| gcc | Кодогенератор для компилятора Си. |
| gas | Кодогенератор для ассемблера |
| gas64 | 64‐битный ассемблер |
| llvm | Низкоуровневая виртуальная машина |
| wasm32 | WebAssembly 32 бит |
| wasm64 | WebAssembly 64 бит |

По умолчанию равен `gcc`.

Примечание: поддержка wasm64 в браузерах находится в экспериментальном режиме, и может не работать корректно.

### fix

Добавляет сценарий исправления сгенерированного промежуточного кода.

Пояснение: компилятор фрибейсика генерирует промежуточный код для GCC и использует расширения GCC. Некоторые конструкции не будут работать для другого компилятора, например, для шланга.

По умолчанию `false`.

### unicode

Задаёт константу `UNICODE` для WinAPI.

| Юникод | Описание                          |
|-----|-----------------------------------|
| true | Включает `UNICODE` |
| false | Выключает `UNICODE` |

По умолчанию равен `false`.

### wrt

Выключает библиотеки времени выполнения. Чтобы выключить библиотеки, установите этот параметр в `true`.

По умолчанию равен `false`.

### addressaware

Включает использование адресного пространства больше 2 гигабайт.

Чтобы использовать адресное пространство больше двух гигабайт, исполняемый файл должен быть отмечен этим флагом. Установите это значение в `true`. Применимо только для 32‐битных программ.

По умолчанию равен `false`.

### multithreading

Включает многопоточные библиотеки времени выполнения.

По умолчанию равен `false`.

### usefilesuffix

Включает использование файлового суффикса.

По умолчанию равен `true`.

### pedantic

Включает строгое следование стандарту языка Си для промежуточного представления.

По умолчанию равен `true`.

### winver

Задаёт версию Windows: константы `WINVER` и `_WIN32_WINNT`. В десятичном формате. Допустимые значения:

| Именованная константа | 16‐ричный | Десятичный | Описание |
|-----------------------|-----------|------------|----------|
| _WIN32_WINNT_NT4      | 0x0400    | 1024       | Windows NT 4.0 и Windows 95 |
| _WIN32_WINNT_WIN2K    | 0x0500    | 1280       | Windows 2000 |
| _WIN32_WINNT_WINXP    | 0x0501    | 1281       | Windows XP |
| _WIN32_WINNT_WS03     | 0x0502    | 1282       | Windows Server 2003 |
| _WIN32_WINNT_WIN6     | 0x0600    | 1536       | Windows Vista |
| _WIN32_WINNT_VISTA    | 0x0600    | 1536       | Windows Vista |
| _WIN32_WINNT_WS08     | 0x0600    | 1536       | Windows Server 2008 |
| _WIN32_WINNT_LONGHORN | 0x0600    | 1536       | Windows Vista |
| _WIN32_WINNT_WIN7     | 0x0601    | 1537       | Windows 7 |
| _WIN32_WINNT_WIN8     | 0x0602    | 1538       | Windows 8 |
| _WIN32_WINNT_WINBLUE  | 0x0603    | 1539       | Windows 8.1 |
| _WIN32_WINNT_WINTHRESHOLD | 0x0A00 | 2560      | Windows 10 |
| _WIN32_WINNT_WIN10    | 0x0A00    | 2560       | Windows 10 |

По умолчанию `1024` (Windows NT 4.0).

### create-environment-file

Включает генерацию файла настроек среды выполнения для утилиты `make`.

По умолчанию `true`.

## Параметры для утилиты make

Переменные среды, которые нужны для запуска.

### Цепочки инструментов

FBC ?= fbc.exe
CC ?= gcc.exe
AS ?= as.exe
AR ?= ar.exe
GORC ?= GoRC.exe
LD ?= ld.exe
DLL_TOOL ?= dlltool.exe
LIB_DIR ?=
INC_DIR ?=
LD_SCRIPT ?=
FLTO ?=


USE_RUNTIME ?=TRUE или FALSE
FBC_VER ?= _FBC1100
GCC_VER ?= _GCC0930

### Модель процессора

PROCESSOR_ARCHITECTURE=AMD64 или x86
TARGET_TRIPLET ?=
MARCH ?= native

### Версия ОС

WINVER ?=
_WIN32_WINNT ?=

## Примеры

### GUI Программа

Оконная программа с поддержкой юникода, библиотеками времени выполнения и адресного пространства больше 2 гигабайт:

```
CreateMakefile.exe -out HelloWorld -subsystem windows -unicode true -addressaware true
```

### Консольная программа

Консольная программа с поддержкой юникода и адресного пространства больше 2 гигабайт:

```
CreateMakefile.exe -out HelloWorld -subsystem console -unicode true -addressaware true
```

### Все параметры

```
CreateMakefile.exe -makefile Makefile -src src -fbc-path "C:\Program Files (x86)\FreeBASIC-1.10.0-winlibs-gcc-9.3.0" -fbc fbc64.exe -out HelloWorld -module WinMain -exetype exe -subsystem console -emitter gcc -fix true -unicode true -wrt true -addressaware true -multithreading false -usefilesuffix true -pedantic true -winver 1281 -create-environment-file true
```

### WebAssembly

```
CreateMakefile.exe -out HelloWorld -fix true -emitter wasm32 -exetype wasm32
```
